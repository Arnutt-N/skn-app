============================= test session starts ==============================
platform linux -- Python 3.13.12, pytest-9.0.2, pluggy-1.6.0 -- /mnt/d/genAI/skn-app/backend/venv_linux/bin/python
cachedir: .pytest_cache
rootdir: /mnt/d/genAI/skn-app/backend
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 95 items

tests/test_admin_analytics_export_endpoints.py::test_dashboard_endpoint_returns_aggregated_payload PASSED [  1%]
tests/test_admin_analytics_export_endpoints.py::test_export_csv_endpoint_streams_file PASSED [  2%]
tests/test_admin_analytics_export_endpoints.py::test_export_pdf_endpoint_streams_file PASSED [  3%]
tests/test_admin_analytics_export_endpoints.py::test_refresh_profile_endpoint_returns_updated_user PASSED [  4%]
tests/test_analytics_service.py::test_abandonment_rate_zero_when_no_sessions PASSED [  5%]
tests/test_analytics_service.py::test_abandonment_rate_calculation PASSED [  6%]
tests/test_analytics_service.py::test_emit_live_kpis_update_broadcasts_to_subscribers PASSED [  7%]
tests/test_analytics_service.py::test_get_operator_availability_map_returns_zero_when_redis_disconnected PASSED [  8%]
tests/test_analytics_service.py::test_get_operator_performance_includes_availability_and_queue_wait PASSED [  9%]
tests/test_analytics_service.py::test_calculate_sla_breach_events_sums_all_categories PASSED [ 10%]
tests/test_friend_service.py::test_refresh_profile_skips_when_not_stale PASSED [ 11%]
tests/test_friend_service.py::test_refresh_profile_updates_when_stale PASSED [ 12%]
tests/test_line_service_circuit_breaker.py::test_circuit_opens_after_failure_threshold_and_fast_fails PASSED [ 13%]
tests/test_line_service_circuit_breaker.py::test_circuit_recovers_after_timeout_and_success PASSED [ 14%]
tests/test_live_chat_media_service.py::test_send_media_image_success PASSED [ 15%]
tests/test_live_chat_media_service.py::test_send_media_file_sends_text_with_url PASSED [ 16%]
tests/test_live_chat_media_service.py::test_send_media_image_requires_public_url PASSED [ 17%]
tests/test_live_chat_service.py::TestClaimSession::test_claim_waiting_session PASSED [ 18%]
tests/test_live_chat_service.py::TestClaimSession::test_claim_nonexistent_session PASSED [ 20%]
tests/test_live_chat_service.py::TestClaimSession::test_claim_already_active_session PASSED [ 21%]
tests/test_live_chat_service.py::TestCloseSession::test_close_active_session PASSED [ 22%]
tests/test_live_chat_service.py::TestCloseSession::test_close_nonexistent_session PASSED [ 23%]
tests/test_live_chat_service.py::TestGetActiveSession::test_returns_waiting_session PASSED [ 24%]
tests/test_live_chat_service.py::TestGetActiveSession::test_returns_active_session PASSED [ 25%]
tests/test_live_chat_service.py::TestGetActiveSession::test_returns_none_when_no_session PASSED [ 26%]
tests/test_live_chat_service.py::TestSearchMessages::test_search_messages_returns_formatted_items PASSED [ 27%]
tests/test_live_chat_service.py::TestUnreadCount::test_unread_count_uses_read_marker PASSED [ 28%]
tests/test_live_chat_service.py::TestUnreadCount::test_unread_count_without_read_marker PASSED [ 29%]
tests/test_multi_operator.py::TestMultipleOperators::test_presence_shows_online_operators PASSED [ 30%]
tests/test_multi_operator.py::TestMultipleOperators::test_two_operators_connect_independently PASSED [ 31%]
tests/test_multi_operator.py::TestMultipleOperatorsWithDB::test_two_operators_join_same_room SKIPPED [ 32%]
tests/test_reconnection.py::TestReconnection::test_reconnect_with_same_admin_id PASSED [ 33%]
tests/test_reconnection.py::TestReconnection::test_multiple_tabs_same_admin PASSED [ 34%]
tests/test_reconnection.py::TestReconnection::test_different_admins_independent PASSED [ 35%]
tests/test_reconnection.py::TestReconnection::test_room_state_not_preserved_after_disconnect PASSED [ 36%]
tests/test_reconnection.py::TestReconnectionWithDB::test_room_must_rejoin_after_reconnect SKIPPED [ 37%]
tests/test_session_claim.py::TestSessionClaimWithDB::test_claim_session_flow SKIPPED [ 38%]
tests/test_session_claim.py::TestSessionClaim::test_claim_requires_room PASSED [ 40%]
tests/test_session_claim.py::TestSessionClaim::test_close_session_requires_room PASSED [ 41%]
tests/test_session_cleanup.py::test_process_inactive_sessions_handles_abandoned_waiting PASSED [ 42%]
tests/test_sla_service.py::test_queue_wait_breach_emits_ws_alert PASSED  [ 43%]
tests/test_sla_service.py::test_resolution_within_threshold_does_not_emit_alert PASSED [ 44%]
tests/test_sla_service.py::test_frt_breach_sends_telegram_when_enabled PASSED [ 45%]
tests/test_tag_service.py::TestCreateTag::test_create_tag_rejects_invalid_color PASSED [ 46%]
tests/test_tag_service.py::TestCreateTag::test_create_tag_handles_duplicate_name PASSED [ 47%]
tests/test_tag_service.py::TestAssignTag::test_assign_tag_to_user_not_found PASSED [ 48%]
tests/test_tag_service.py::TestAssignTag::test_remove_tag_from_user_returns_false_when_absent PASSED [ 49%]
tests/test_webhook_deduplication.py::TestWebhookDeduplication::test_duplicate_event_skipped PASSED [ 50%]
tests/test_webhook_deduplication.py::TestWebhookDeduplication::test_new_event_processed PASSED [ 51%]
tests/test_webhook_deduplication.py::TestWebhookDeduplication::test_event_without_id_processed PASSED [ 52%]
tests/test_webhook_deduplication.py::TestWebhookDeduplication::test_multiple_events_mixed PASSED [ 53%]
tests/test_webhook_deduplication.py::TestRedisClient::test_exists_with_no_connection PASSED [ 54%]
tests/test_webhook_deduplication.py::TestRedisClient::test_setex_with_no_connection PASSED [ 55%]
tests/test_webhook_deduplication.py::TestRedisClient::test_is_connected_property PASSED [ 56%]
tests/test_webhook_media.py::TestExtractNonTextMessage::test_image_message_with_media_persistence PASSED [ 57%]
tests/test_webhook_media.py::TestExtractNonTextMessage::test_image_message_without_id_returns_null_media_urls PASSED [ 58%]
tests/test_webhook_media.py::TestExtractNonTextMessage::test_sticker_message_maps_ids PASSED [ 60%]
tests/test_webhook_media.py::TestExtractNonTextMessage::test_file_message_uses_persisted_filename PASSED [ 61%]
tests/test_webhook_media.py::TestExtractNonTextMessage::test_unsupported_message_returns_none PASSED [ 62%]
tests/test_websocket.py::test_websocket_connect_and_auth PASSED          [ 63%]
tests/test_websocket.py::test_websocket_ping_pong PASSED                 [ 64%]
tests/test_websocket.py::test_websocket_requires_auth PASSED             [ 65%]
tests/test_websocket.py::test_websocket_unknown_message_type PASSED      [ 66%]
tests/test_websocket.py::test_websocket_join_room_requires_line_user_id PASSED [ 67%]
tests/test_websocket.py::test_websocket_send_message_requires_room PASSED [ 68%]
tests/test_websocket.py::test_websocket_send_message_requires_text SKIPPED [ 69%]
tests/test_websocket.py::test_websocket_leave_room SKIPPED (Requires...) [ 70%]
tests/test_websocket.py::test_websocket_typing_indicators SKIPPED (R...) [ 71%]
tests/test_websocket.py::test_websocket_join_room_valid_format SKIPPED   [ 72%]
tests/test_websocket_manager_redis.py::test_is_admin_in_room_global_uses_server_room_sets PASSED [ 73%]
tests/test_websocket_manager_redis.py::test_server_scoped_room_membership_does_not_remove_other_servers PASSED [ 74%]
tests/test_websocket_manager_redis.py::test_mark_operator_offline_aggregates_same_day_availability PASSED [ 75%]
tests/test_websocket_manager_redis.py::test_mark_operator_offline_aggregates_cross_day_availability PASSED [ 76%]
tests/test_ws_security.py::TestRateLimiter::test_allows_within_limit PASSED [ 77%]
tests/test_ws_security.py::TestRateLimiter::test_blocks_over_limit PASSED [ 78%]
tests/test_ws_security.py::TestRateLimiter::test_resets_after_window PASSED [ 80%]
tests/test_ws_security.py::TestRateLimiter::test_get_remaining PASSED    [ 81%]
tests/test_ws_security.py::TestRateLimiter::test_reset_clears_bucket PASSED [ 82%]
tests/test_ws_security.py::TestRateLimiter::test_independent_clients PASSED [ 83%]
tests/test_ws_security.py::TestAuthPayloadValidation::test_valid_token PASSED [ 84%]
tests/test_ws_security.py::TestAuthPayloadValidation::test_token_whitespace_stripped PASSED [ 85%]
tests/test_ws_security.py::TestAuthPayloadValidation::test_missing_token_fails PASSED [ 86%]
tests/test_ws_security.py::TestAuthPayloadValidation::test_short_token_fails PASSED [ 87%]
tests/test_ws_security.py::TestSendMessagePayloadValidation::test_valid_message PASSED [ 88%]
tests/test_ws_security.py::TestSendMessagePayloadValidation::test_html_tags_stripped PASSED [ 89%]
tests/test_ws_security.py::TestSendMessagePayloadValidation::test_whitespace_normalized PASSED [ 90%]
tests/test_ws_security.py::TestSendMessagePayloadValidation::test_empty_message_fails PASSED [ 91%]
tests/test_ws_security.py::TestSendMessagePayloadValidation::test_message_too_long_fails PASSED [ 92%]
tests/test_ws_security.py::TestSendMessagePayloadValidation::test_temp_id_optional PASSED [ 93%]
tests/test_ws_security.py::TestJoinRoomPayloadValidation::test_valid_line_user_id PASSED [ 94%]
tests/test_ws_security.py::TestJoinRoomPayloadValidation::test_invalid_format_fails PASSED [ 95%]
tests/test_ws_security.py::TestJoinRoomPayloadValidation::test_missing_U_prefix_fails PASSED [ 96%]
tests/test_ws_security.py::TestJWTTokenGeneration::test_create_valid_token PASSED [ 97%]
tests/test_ws_security.py::TestJWTTokenGeneration::test_expired_token_fails PASSED [ 98%]
tests/test_ws_security.py::TestJWTTokenGeneration::test_invalid_signature_fails PASSED [100%]

=============================== warnings summary ===============================
app/db/base.py:3
  /mnt/d/genAI/skn-app/backend/app/db/base.py:3: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

app/schemas/friend_event.py:23
  /mnt/d/genAI/skn-app/backend/app/schemas/friend_event.py:23: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FriendEventResponse(FriendEventBase):

app/schemas/ws_events.py:60
  /mnt/d/genAI/skn-app/backend/app/schemas/ws_events.py:60: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class WSMessage(BaseModel):

app/schemas/credential.py:30
  /mnt/d/genAI/skn-app/backend/app/schemas/credential.py:30: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CredentialResponse(CredentialBase):

app/schemas/reply_object.py:44
  /mnt/d/genAI/skn-app/backend/app/schemas/reply_object.py:44: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReplyObjectResponse(ReplyObjectBase):

app/schemas/auto_reply.py:46
  /mnt/d/genAI/skn-app/backend/app/schemas/auto_reply.py:46: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AutoReplyResponse(AutoReplyBase):

app/schemas/intent.py:33
  /mnt/d/genAI/skn-app/backend/app/schemas/intent.py:33: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class IntentKeywordResponse(IntentKeywordBase):

app/schemas/intent.py:62
  /mnt/d/genAI/skn-app/backend/app/schemas/intent.py:62: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class IntentResponseResponse(IntentResponseBase):

app/schemas/intent.py:85
  /mnt/d/genAI/skn-app/backend/app/schemas/intent.py:85: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class IntentCategoryResponse(IntentCategoryBase):

app/schemas/service_request_liff.py:5
  /mnt/d/genAI/skn-app/backend/app/schemas/service_request_liff.py:5: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ServiceRequestCreate(BaseModel):

app/schemas/service_request_liff.py:54
  /mnt/d/genAI/skn-app/backend/app/schemas/service_request_liff.py:54: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ServiceRequestResponse(ServiceRequestCreate):

app/schemas/service_request_liff.py:74
  /mnt/d/genAI/skn-app/backend/app/schemas/service_request_liff.py:74: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RequestCommentResponse(RequestCommentBase):

app/schemas/rich_menu.py:11
  /mnt/d/genAI/skn-app/backend/app/schemas/rich_menu.py:11: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SystemSettingResponse(SystemSettingBase):

app/schemas/rich_menu.py:50
  /mnt/d/genAI/skn-app/backend/app/schemas/rich_menu.py:50: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RichMenuResponse(BaseModel):

app/schemas/chat_session.py:23
  /mnt/d/genAI/skn-app/backend/app/schemas/chat_session.py:23: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ChatSessionResponse(ChatSessionBase):

app/schemas/message.py:15
  /mnt/d/genAI/skn-app/backend/app/schemas/message.py:15: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class MessageResponse(BaseModel):

app/main.py:46
  /mnt/d/genAI/skn-app/backend/app/main.py:46: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

venv_linux/lib/python3.13/site-packages/fastapi/applications.py:4579
venv_linux/lib/python3.13/site-packages/fastapi/applications.py:4579
  /mnt/d/genAI/skn-app/backend/venv_linux/lib/python3.13/site-packages/fastapi/applications.py:4579: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

app/main.py:80
  /mnt/d/genAI/skn-app/backend/app/main.py:80: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================= 88 passed, 7 skipped, 20 warnings in 33.78s ==================
